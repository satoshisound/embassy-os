<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <pwa-back-button></pwa-back-button>
    </ion-buttons>
    <ion-title>Service</ion-title>
    <ion-buttons slot="end">
      <badge-menu-button></badge-menu-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding-bottom" *ngIf="patch.watch$('package-data', pkgId) | ngrxPush as localPkg">

  <ion-spinner *ngIf="loading; else loaded" class="center" name="lines" color="warning"></ion-spinner>

  <ng-template #loaded>
    <ion-item *ngIf="error" style="margin-bottom: 16px;">
      <ion-text class="ion-text-wrap" color="danger">{{ error }}</ion-text>
    </ion-item>

    <ion-item-group>
      <ion-item lines="none">
        <ion-avatar slot="start">
          <img [src]="pkg.icon" />
        </ion-avatar>
        <ion-label class="ion-text-wrap">
          <h1 style="font-family: 'Montserrat'">{{ pkg.manifest.title }}</h1>
          <h3>{{ pkg.manifest.version | displayEmver }}</h3>
          <!-- not installed -->
          <h3 *ngIf="!localPkg.installed; else installed">
            <!-- not installing -->
            <ion-text *ngIf="localPkg.state !== PackageState.Installing; else installing" color="medium">Not Installed</ion-text>
            <!-- installing -->
            <ng-template #installing>
              <ion-text ngIf="localPkg.state === PackageState.Installing" color="primary">Installing</ion-text>
              <ion-spinner class="dots dots-medium" name="dots" color="primary"></ion-spinner>
            </ng-template>
          </h3>
          <!-- installed -->
          <ng-template #installed>
            <!-- static -->
            <h3 *ngIf="localPkg.state === PackageState.Installed">
              <ion-text color="medium">Installed at {{ localPkg.installed.manifest.version | displayEmver }}</ion-text>
            </h3>
            <!-- updating -->
            <h3 *ngIf="localPkg.state === PackageState.Updating">
              <ion-text color="primary">Updating</ion-text>
              <ion-spinner class="dots dots-medium" name="dots" color="primary"></ion-spinner>
            </h3>
            <!-- removing -->
            <h3 *ngIf="localPkg.state === PackageState.Removing">
              <ion-text color="danger">Removing</ion-text>
              <ion-spinner class="dots dots-medium" name="dots" color="danger"></ion-spinner>
            </h3>
          </ng-template>
        </ion-label>

      </ion-item>
    </ion-item-group>

    <!-- not installed -->
    <ion-button *ngIf="localPkg | empty; else local" class="main-action-button" expand="block" fill="outline" color="success" (click)="install()">
      Install
    </ion-button>

    <ng-template #local>
      <!-- not removing -->
      <ng-container *ngIf="localPkg.state !== PackageState.Removing">
        <ion-button class="main-action-button" expand="block" fill="outline" [routerLink]="['/services', 'installed', pkgId]">
          Go to Service
        </ion-button>
        <!-- not installing or updating -->
        <ng-container *ngIf="localPkg.state === PackageState.Installed">
          <ion-button *ngIf="(localPkg.installed.manifest.version | compareEmver : pkg.manifest.version) === -1" class="main-action-button" expand="block" fill="outline" color="success" (click)="update('update')">
            Update to {{ pkg.manifest.version | displayEmver }}
          </ion-button>
          <ion-button *ngIf="(localPkg.installed.manifest.version | compareEmver : pkg.manifest.version) === 1" class="main-action-button" expand="block" fill="outline" color="warning" (click)="update('downgrade')">
            Downgrade to {{ pkg.manifest.version | displayEmver }}
          </ion-button>
        </ng-container>
      </ng-container>
    </ng-template>

    <ion-item-group>
      <ng-container *ngIf="recommendation">
        <ion-item class="recommendation-item">
          <ion-label class="ion-text-wrap">
            <h2 style="display: flex; align-items: center;">
              <ion-avatar style="height: 3vh; width: 3vh; margin: 5px" slot="start">
                <img [src]="recommendation.iconURL" [alt]="recommendation.title"/>
              </ion-avatar>
              <ion-text style="margin: 5px; font-family: 'Montserrat'; font-size: smaller;">{{recommendation.title}}</ion-text>
            </h2>
            <div style="margin: 2px 5px">
              <p style="color: var(--ion-color-medium); font-size: small">{{recommendation.description}}</p>
              <p *ngIf="vars.versionViewing | satisfiesEmver: recommendation.versionSpec" class="recommendation-text">{{vars.title}} version {{vars.versionViewing | displayEmver}} is compatible.</p>
              <p *ngIf="!(vars.versionViewing | satisfiesEmver: recommendation.versionSpec)" class="recommendation-text recommendation-error">{{vars.title}} version {{vars.versionViewing | displayEmver}} is NOT compatible.</p>
            </div>
          </ion-label>
        </ion-item>
      </ng-container>

      <ion-item-divider style="color: var(--ion-color-dark); font-weight: bold;">New in {{ pkg.manifest.version | displayEmver }}</ion-item-divider>
      <ion-item lines="none">
        <ion-label style="display: flex; align-items: center; justify-content: space-between;" class="ion-text-wrap" >
          <div id='release-notes' color="dark" [innerHTML]="pkg.manifest['release-notes'] | markdown"></div>
        </ion-label>
      </ion-item>

      <ion-item-divider class="divider">Description</ion-item-divider>
      <ion-item lines="none">
        <ion-label class="ion-text-wrap">
          <ion-text color="medium">
            <h5>{{ pkg.manifest.description.long }}</h5>
          </ion-text>
        </ion-label>
      </ion-item>

      <!-- <ng-container *ngIf="(vars.serviceRequirements)?.length">
        <ion-item-divider class="divider">Service Dependencies
          <ion-button style="position: relative; right: 10px;" size="small" fill="clear" color="medium"  (click)="presentPopover(serviceDependencyDefintion, $event)">
            <ion-icon name="help-circle-outline"></ion-icon>
          </ion-button>
        </ion-item-divider>
        <dependency-list [$loading$]="$dependenciesLoading$" [hostApp]="$app$ | peekProperties" [dependencies]="vars.serviceRequirements"></dependency-list>
      </ng-container> -->

      <ion-item-divider></ion-item-divider>

      <ion-item lines="none" button (click)="presentAlertVersions()">
        <ion-icon color="medium" slot="start" name="file-tray-stacked-outline"></ion-icon>
        <ion-label color="medium">Other versions</ion-label>
      </ion-item>
    </ion-item-group>

  </ng-template>
</ion-content>